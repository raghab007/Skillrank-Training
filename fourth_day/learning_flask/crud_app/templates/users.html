<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Users</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users">Users</a>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <input
              class="form-control me-2"
              type="search"
              placeholder="Search"
              aria-label="Search"
            />
            <button class="btn btn-outline-success" type="submit">
              Search
            </button>
          </form>
        </div>
      </div>
    </nav>
    <div>
      <button onclick="go()" style="margin-top: 10px" class="btn btn-secondary">
        Go back
      </button>
    </div>

    <table class="table" style="margin-top: 15px">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name</th>
          <th scope="col">Email</th>
          <th scope="col">Address</th>
          <th scope="col">Phone</th>
          <th scope="col">Age</th>
          <th style="margin-left: 30px" scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr>
          <th scope="row">1</th>
          <td>Mark</td>
          <td>raghab@gmail.com</td>
          <td>@Kathmandu</td>
          <td>968686868</td>
          <td>22</td>
        </tr>
      </tbody>
    </table>

    <div id="update-modal" style="display: none">
      <form
        onsubmit="updateUser(event)"
        style="display: flex; flex-direction: column; align-items: center"
      >
        <div class="mb-2" style="width: 350px">
          <label for="name" class="form-label">Name</label>
          <input
            type="text"
            class="form-control"
            id="name"
            aria-describedby="emailHelp"
          />
        </div>

        <div class="mb-2" style="width: 350px">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" />
        </div>
        <div class="mb-2" style="width: 350px">
          <label for="address" class="form-label">Address</label>
          <input type="text" class="form-control" id="address" />
        </div>
        <div class="mb-2" style="width: 350px">
          <label for="phone" class="form-label">Phone</label>
          <input type="text" class="form-control" id="phone" />
        </div>
        <div class="mb-2" style="width: 350px">
          <label for="age" class="form-label">Age</label>
          <input type="number" class="form-control" id="age" />
        </div>
        <div>
          <button type="submit" class="btn btn-primary">Update user</button>
        </div>
      </form>
    </div>

    <script>
      const API = "http://127.0.0.1:5000/api";
      function go() {
        window.location.href = "/";
      }
      async function fetchUsers() {
        const url = `${API}/users/1/10`;
        const response = await fetch(url, { method: "GET" });
        const users = await response.json();

        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = ""; // clear existing rows

        console.log(users);
        users.forEach((user, index) => {
          const row = document.createElement("tr");
          row.setAttribute("data-id", user._id.$oid); // store the id in a custom attribute
          row.innerHTML = `
            <th scope="row">${index + 1}</th>
            <td>${user.name || ""}</td>
            <td>${user.email || ""}</td>
            <td>${user.address || ""}</td>
            <td>${user.phone || ""}</td>
            <td>${user.age || ""}</td>
            <td><button onclick='deleteUser(event)' class='btn bg-danger'>Delete</button></td>
            <td><button onclick='openUpdateModal(event)' class='btn btn-info'>Update</button></td>
        `;

          tbody.appendChild(row);
        });
      }
      fetchUsers();
      async function deleteUser(e) {
        e.preventDefault();
        element = e.target;
        tr = element.parentElement.parentElement;
        id = tr.getAttribute("data-id");
        const url = `${API}/users/${id}`;
        let response = await fetch(url, {
          method: "DELETE",
        });
        response = await response.json();
        console.log(response);
        alert(response.message);
        window.location.reload();
      }

      async function openUpdateModal(e) {
        e.preventDefault();
        const button = e.target;
        // updateModal = document.querySelector("#update-modal")
        // updateModal.style.display = "block"
        // console.log(element.parentElement.parentElement)
        // console.log(element.closest('td'))
        const row = button.closest("tr");
        const id = row.getAttribute("data-id");
        const cells = row.querySelectorAll("td");
        const name = cells[0].innerText;
        const email = cells[1].innerText;
        const address = cells[2].innerText;
        const phone = cells[3].innerText;
        const age = cells[4].innerText;
        console.log({
          id,
          name,
          email,
          address,
          phone,
          age,
        });

        document.getElementById("name").value = name;
        document.getElementById("email").value = email;
        document.getElementById("address").value = address;
        document.getElementById("phone").value = phone;
        document.getElementById("age").value = age;

        const updateModal = document.querySelector("#update-modal");
  updateModal.style.display = "block";

        // Optional: store the user ID somewhere to use when saving
        updateModal.setAttribute("data-id", id);
      }


     async function updateUser(e){
        e.preventDefault()
        form = e.target
        parentDiv = e.target.closest('div')
        name = document.getElementById("name").value
        email =document.getElementById("email").value
        address = document.getElementById("address").value 
        phone = document.getElementById("phone").value 
        age = document.getElementById("age").value 
        id = parentDiv.getAttribute('data-id')
       const user = {
        name, address, email, phone, age
       }
        const url = `${API}/users/${id}`
        const response = await fetch (
          url,
          {
            method:'PUT',
            body:JSON.stringify(user),
            headers:{"Content-Type":"application/json"}
          }
        )
        const result = await response.json()
        window.location.reload();
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
